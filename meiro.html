<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スマブラ 二人用</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: black;
            color: white;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        .stage {
            width: 800px;
            height: 400px;
            background-color: #e0e0e0;
            margin: 50px auto;
            position: relative;
            border: 2px solid #000;
            overflow: hidden;
        }
        .floor {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 30px;
            background-color: #4CAF50;
        }
        .player {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: #4CAF50;
            position: absolute;
            bottom: 30px; 
            transition: transform 0.1s ease;
        }
        .player2 {
            background-color: #FF5722;
        }
        .sword {
            width: 10px;
            height: 40px;
            background-color: #FFD700;
            position: absolute;
            top: 0;
            left: -8px;
            transform-origin: 0% 50%;
            transition: transform 0.2s ease;
        }
        .sword-left {
            left: 48px;
            transform-origin: 100% 50%;
        }
        .scoreboard {
            margin-top: 20px;
            font-size: 24px;
        }
        .btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .health-bar {
            width: 50px;
            height: 5px;
            background-color: #FF0000;
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 3px;
        }
        .health-bar-fill {
            height: 100%;
            background-color: #00FF00;
            width: 100%;
            border-radius: 3px;
        }
        .player.guard {
            background-color: #FFC107;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="stage">
        <div id="player1" class="player" style="left: 100px; bottom: 30px;">
            <div class="health-bar" id="health-bar1">
                <div class="health-bar-fill" id="health-fill1"></div>
            </div>
            <div class="sword sword-left" id="sword1"></div>
        </div>
        <div id="player2" class="player player2" style="left: 650px; bottom: 30px;">
            <div class="health-bar" id="health-bar2">
                <div class="health-bar-fill" id="health-fill2"></div>
            </div>
            <div class="sword" id="sword2"></div>
        </div>
        <div class="floor"></div>
    </div>

    <div class="scoreboard">
        <p>Player 1: <span id="score1">0</span> | HP: <span id="hp1">3</span></p>
        <p>Player 2: <span id="score2">0</span> | HP: <span id="hp2">3</span></p>
    </div>

    <button class="btn" onclick="startGame()">ゲーム開始</button>

    <script>
        let score1 = 0;
        let score2 = 0;
        let hp1 = 3;
        let hp2 = 3;

        const player1 = document.getElementById('player1');
        const player2 = document.getElementById('player2');
        const sword1 = document.getElementById('sword1');
        const sword2 = document.getElementById('sword2');
        const score1Element = document.getElementById('score1');
        const score2Element = document.getElementById('score2');
        const hp1Element = document.getElementById('hp1');
        const hp2Element = document.getElementById('hp2');
        const healthFill1 = document.getElementById('health-fill1');
        const healthFill2 = document.getElementById('health-fill2');
        
        const stage = document.querySelector('.stage');
        const stageWidth = stage.offsetWidth;
        const stageHeight = stage.offsetHeight;

        const playerSpeed = 5;
        const jumpStrength = 7;
        let gravity = 1;
        let jumpVelocity1 = 0;
        let jumpVelocity2 = 0;
        let isJumping1 = false;
        let isJumping2 = false;
        let player1Position = { x: 100, y: 30, width: 50, height: 50 };
        let player2Position = { x: 650, y: 30, width: 50, height: 50 };

        // プレイヤーの位置を更新する関数
        function movePlayer(player, targetX, targetY) {
            targetX = Math.max(0, Math.min(stageWidth - 50, targetX)); 
            targetY = Math.max(30, Math.min(stageHeight - 50, targetY)); 
            player.style.left = targetX + 'px';
            player.style.bottom = targetY + 'px';
        }

        // ジャンプを処理する関数
        function jump(player) {
            if (player === 1 && !isJumping1) {
                jumpVelocity1 = jumpStrength;
                isJumping1 = true;
            } else if (player === 2 && !isJumping2) {
                jumpVelocity2 = jumpStrength;
                isJumping2 = true;
            }
        }

        // プレイヤー同士の接触判定
        function checkCollision(p1, p2) {
            return !(p1.x + p1.width < p2.x || p1.x > p2.x + p2.width || p1.y + p1.height < p2.y || p1.y > p2.y + p2.height);
        }

        // 攻撃処理
        let isAttacking1 = false;  // プレイヤー1の攻撃フラグ
        let isAttacking2 = false;  // プレイヤー2の攻撃フラグ

        function attack(player) {
            if (player === 1 && checkCollision(player1Position, player2Position)) {
                if (!isAttacking1) {
                    isAttacking1 = true;  // 攻撃フラグを立てる
                    if (!isGuarding2) {
                        hp2--; 
                    }
                    hp2Element.textContent = hp2;
                    healthFill2.style.width = (hp2 / 3) * 100 + '%'; 

                    if (hp2 <= 0) {
                        alert("Player 1 wins!");
                        startGame(); 
                    }

                    // 攻撃時に剣を振るアニメーション
                    sword1.style.transform = 'rotate(45deg)';
                    setTimeout(() => sword1.style.transform = 'rotate(0deg)', 200);
                    setTimeout(() => isAttacking1 = false, 500);  // 攻撃フラグ解除（待機時間を追加）
                }
            }

            if (player === 2 && checkCollision(player2Position, player1Position)) {
                if (!isAttacking2) {
                    isAttacking2 = true;  // 攻撃フラグを立てる
                    if (!isGuarding1) {
                        hp1--; 
                    }
                    hp1Element.textContent = hp1;
                    healthFill1.style.width = (hp1 / 3) * 100 + '%'; 

                    if (hp1 <= 0) {
                        alert("Player 2 wins!");
                        startGame(); 
                    }

                    // 攻撃時に剣を振るアニメーション
                    sword2.style.transform = 'rotate(-45deg)';
                    setTimeout(() => sword2.style.transform = 'rotate(0deg)', 200);
                    setTimeout(() => isAttacking2 = false, 500);  // 攻撃フラグ解除（待機時間を追加）
                }
            }
        }

        // ゲーム開始時にリセット
        function startGame() {
            score1 = 0;
            score2 = 0;
            hp1 = 3;
            hp2 = 3;
            score1Element.textContent = score1;
            score2Element.textContent = score2;
            hp1Element.textContent = hp1;
            hp2Element.textContent = hp2;
            healthFill1.style.width = '100%';
            healthFill2.style.width = '100%';
            player1.style.left = '100px';
            player2.style.left = '650px';
            player1.style.bottom = '30px';
            player2.style.bottom = '30px';
        }

        // 移動処理
        window.addEventListener('keydown', function(event) {
            // プレイヤー1の移動
            if (event.key === 'w') jump(1);  // プレイヤー1のジャンプ
            if (event.key === 'a') player1Position.x -= playerSpeed;
            if (event.key === 'd') player1Position.x += playerSpeed;

            // プレイヤー2の移動
            if (event.key === 'ArrowUp') jump(2);  // プレイヤー2のジャンプ
            if (event.key === 'ArrowLeft') player2Position.x -= playerSpeed;
            if (event.key === 'ArrowRight') player2Position.x += playerSpeed;

            // 攻撃
            if (event.key === 'q') attack(1);  // プレイヤー1の攻撃
            if (event.key === '/') attack(2);  // プレイヤー2の攻撃
        });

        window.addEventListener('keyup', function(event) {
            if (event.key === 'w') isJumping1 = false;
            if (event.key === 'ArrowUp') isJumping2 = false;
        });

        // 物理エンジン
        function update() {
            if (isJumping1) {
                jumpVelocity1 -= gravity;
                player1Position.y += jumpVelocity1;
            }

            if (isJumping2) {
                jumpVelocity2 -= gravity;
                player2Position.y += jumpVelocity2;
            }

            movePlayer(player1, player1Position.x, player1Position.y);
            movePlayer(player2, player2Position.x, player2Position.y);
        }

        // ゲームループ
        setInterval(update, 1000 / 1000);  // 60FPSで更新
    </script>
</body>
</html>